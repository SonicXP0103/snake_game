<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è²ªé£Ÿè›‡ Snake Game</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>ğŸ è²ªé£Ÿè›‡</h1>
  
  <div id="app">
    <div id="gameContainer">
      <div id="scoreBoard">åˆ†æ•¸ï¼š{{ score }}</div>
      <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <div id="controlPanel">
      <button @click="StartGame">é–‹å§‹éŠæˆ²</button>
      <button @click="ResetGame">é‡æ–°é–‹å§‹</button>
    </div>
  </div>

<!-- âœ… Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- âœ… Vue åˆå§‹åŒ– -->
  <script>
    const { createApp } = Vue;

  // #region å¸¸æ•¸å®šç¾©

  const SNAKE_SIZE      = 20; // è›‡èº«ç¯€é»å¤§å°
  const UPDATE_INTERVAL = 150; // æ›´æ–°é–“éš”æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰

  // #endregion å¸¸æ•¸å®šç¾©

  // #region éŸ³æ•ˆå®šç¾©
  const SOUND = {
      eat: new Audio("sounds/eat.mp3"), // åƒåˆ°é£Ÿç‰©éŸ³æ•ˆ
      gameover: new Audio("sounds/gameover.mp3"), // éŠæˆ²çµæŸéŸ³æ•ˆ
  }

  // #endregion éŸ³æ•ˆå®šç¾©    

    createApp({
      data() {
        return {          
          //score: 0,
          //isInitialized: false,
          //gameStatus: 0,
          // å…¶ä»–é‚„æ²’è½‰é€²ä¾†çš„è³‡æ–™æœƒé™¸çºŒåŠ å…¥

          // æ˜¯å¦å·²åˆå§‹åŒ–éŠæˆ²
          isInitialized: false, 

          // ç•¶å‰æ–¹å‘
          currentDirection: null,

          // éŠæˆ²ç‹€æ…‹ (0: æœªé–‹å§‹, 1: é€²è¡Œä¸­, 2: çµæŸ)
          gameStatus: 0, 

          // è›‡çš„èº«é«”åˆå§‹ä½ç½®
          snake: [
            { x: 100, y: 100 },
            { x: 80, y: 100 },
            { x: 60, y: 100 }
          ],

          // é£Ÿç‰©ä½ç½®åˆå§‹ç‚º (0, 0)
          food: { x: 0, y: 0 },

          // ç”¨ä¾†æ¸…é™¤ setInterval
          intervalId: null,

          // åˆ†æ•¸
          score: 0,

          // é›£åº¦ç­‰ç´š
          level: 1,

          // æ‰‹æ©Ÿæ»‘å‹•æ–¹å‘æ§åˆ¶
          touchStartX: 0,
          touchStartY: 0,

          // ç•«å¸ƒç›¸é—œ
          ctx: null,
          canvas: null,

        };
      },
      methods: {
        startGame() {
          console.log("Vue: é–‹å§‹éŠæˆ²");
          this.score = 0;
          this.isInitialized = true;
          this.gameStatus = 1;
          // ç­‰ä¸‹æœƒæ¬ canvas çš„åˆå§‹åŒ–èˆ‡é‚è¼¯é€²ä¾†
        },
        resetGame() {
          console.log("Vue: é‡æ–°é–‹å§‹");
          this.score = 0;
          this.isInitialized = false;
        },

        // æ‰‹æ©Ÿç‰ˆèª¿æ•´ç•«å¸ƒå¤§å°
        resizeCanvasIfMobile()
        {
            const canvas = document.getElementById("gameCanvas");

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
            const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            if (isMobile)
            {   
                console.log("æ‰‹æ©Ÿç‰ˆ");

                const size = Math.min(window.innerWidth, window.innerHeight) * 0.9;

                canvas.style.width = size + "px";
                canvas.style.height = size + "px";

                canvas.width = size;
                canvas.height = size;
            }
            else
            {
                console.log("é›»è…¦ç‰ˆ");

                // ğŸ’» é›»è…¦ç‰ˆä¿æŒå›ºå®šå°ºå¯¸
                canvas.style.width = "400px";
                canvas.style.height = "400px";

                canvas.width = 400;
                canvas.height = 400;
            }
        },
        
        // åˆå§‹åŒ–éŠæˆ²
        InitializeGame()
        {
            // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
            this.gameStatus = 1; // è¨­å®šç‚ºé€²è¡Œä¸­

            // é‡ç½®åˆ†æ•¸
            this.score = 0;

            // é‡ç½®è›‡çš„èº«é«”
            this.snake = [
                { x: 100, y: 100 },
                { x: 80, y: 100 },
                { x: 60, y: 100 }
            ];

            // è¨­å®šåˆå§‹æ–¹å‘
            this.currentDirection = "right";

            // ç”Ÿæˆé£Ÿç‰©
            this.GenerateFood();

            // æ›´æ–°åˆ†æ•¸ UI
            this.UpdateScoreUI();
        },

        // é–‹å§‹éŠæˆ²æŒ‰éˆ•
        StartGame()
        {
            // å·²åˆå§‹åŒ–
            if (this.isInitialized){
                return;
            }

            this.isInitialized = true;

            // è¨­å®šæ›´æ–°å¾ªç’°
            this.intervalId = setInterval(() => {
                this.Update();
            }, UPDATE_INTERVAL);

           this.InitializeGame();
        },

        // é‡æ–°é–‹å§‹éŠæˆ²
        ResetGame()
        {
            clearInterval(this.intervalId);
            this.isInitialized = false;
            this.currentDirection = null;

            this.StartGame()
        },

        // çµæŸéŠæˆ²
        EndGame()
        {
            this.gameStatus = 2;
            clearInterval(this.intervalId);
            this.isInitialized = false;
            this.currentDirection = null;

            // æ’­æ”¾éŠæˆ²çµæŸéŸ³æ•ˆ
            SOUND.gameover.currentTime = 0;
            SOUND.gameover.play();

            // éœ‡å‹• 500 æ¯«ç§’ï¼ˆæ‰‹æ©Ÿï¼‰
            if (navigator.vibrate) {
                navigator.vibrate(500);
            }
        },

        /**
         * @brief: æ›´æ–°éŠæˆ²ç‹€æ…‹å‡½æ•¸
         * @details: æ¯éš”ä¸€æ®µæ™‚é–“ç§»å‹•è›‡çš„èº«é«”
         */
        Update()
        {
            if (this.isInitialized === false || this.gameStatus !== 1) {
                return; // å¦‚æœéŠæˆ²æœªåˆå§‹åŒ–æˆ–æœªé–‹å§‹ï¼Œå‰‡ä¸åŸ·è¡Œæ›´æ–°
            }

            this.moveSnake(this.currentDirection);

            this.RenderPanel();
        },

        // æ¸²æŸ“æ•´å€‹ç•«å¸ƒ
        RenderPanel()
        {
            // æ¸…é™¤ç•«å¸ƒ
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            // æ¸²æŸ“è›‡çš„èº«é«”
            this.RenderSnake();

            // æ¸²æŸ“é£Ÿç‰©
            this.RenderFood();

            // æ¸²æŸ“åˆ†æ•¸
            //this.RenderScore();

            // éŠæˆ²çµæŸæ™‚æ¸²æŸ“çµæŸç•«é¢
            if (this.gameStatus === 2) {
                this.RenderGameOver()
            }
        },

        // @brief æ¸²æŸ“è›‡çš„èº«é«”
        RenderSnake()
        {
            // ç•«ä¸€å€‹æ–¹å¡Šï¼ˆç•¶ä½œè›‡çš„èº«é«”ï¼‰
            this.ctx.fillStyle = "#66ff66"; // ç¶ è‰²
            //this.ctx.fillRect(100, 100, 20, 20); // (x, y, å¯¬, é«˜)
            
            // ç•«èº«é«”ç¯€é»çš„å¤–æ¡†
            this.ctx.strokeStyle = "#000000"; // é»‘è‰²
            this.ctx.lineWidth = 2; // ç·šå¯¬
            
            // ç¹ªè£½è›‡çš„èº«é«”
            for (let i = 0; i < this.snake.length; i++)
            {
                this.ctx.fillRect(this.snake[i].x, this.snake[i].y, SNAKE_SIZE, SNAKE_SIZE);
                this.ctx.strokeRect(this.snake[i].x, this.snake[i].y, SNAKE_SIZE, SNAKE_SIZE);
            }
        },

        /**
         * @brief: æ¸²æŸ“é£Ÿç‰©
         * @details: åœ¨ç•«å¸ƒä¸Šæ¸²æŸ“é£Ÿç‰©ï¼Œä½¿ç”¨ç´…è‰²æ–¹å¡Šæˆ–Emoji
         */
        RenderFood()
        {
            // ç´…è‰²æ¨£å¼
            // this.ctx.fillStyle = "#ff0000"; // ç´…è‰²
            // this.ctx.fillRect(this.food.x, this.food.y, SNAKE_SIZE, SNAKE_SIZE);
            
            // æ”¹ç•«Emojiçš„è˜‹æœ
            this.ctx.font = "20px Arial"; // è¨­å®šå­—é«”å¤§å°
            this.ctx.fillStyle = "#ff0000"; // ç´…è‰²
            this.ctx.fillText("ğŸ", this.food.x + 2, this.food.y + 18); // ç•«è˜‹æœEmojiï¼Œèª¿æ•´ä½ç½®ä»¥å°é½Šæ ¼å­
            this.ctx.strokeStyle = "#000000"; // é»‘è‰²é‚Šæ¡†
            this.ctx.lineWidth = 1; // é‚Šæ¡†å¯¬åº¦
            this.ctx.strokeText("ğŸ", this.food.x + 2, this.food.y + 18); // ç•«è˜‹æœEmojié‚Šæ¡†
        },

        /**
         * @brief: æ¸²æŸ“åˆ†æ•¸(ä¸»æ¡†æ¶ä¸­ï¼Œå·²æ£„ç”¨)
         * @details: åœ¨éŠæˆ²å±¤ç•«å¸ƒä¸Šæ¸²æŸ“åˆ†æ•¸ï¼Œä½¿ç”¨è—è‰²å­—é«”
         */
        RenderScore()
        {
            this.ctx.fillStyle = "#283adbff";
            this.ctx.font = "20px Arial";
            this.ctx.fillText("åˆ†æ•¸ï¼š" + this.score, 10, 30);
        },

        RenderGameOver()
        {
            message = "éŠæˆ²çµæŸ";

            // é¡¯ç¤ºéŠæˆ²çµæŸè¨Šæ¯
            //alert(message);
            
            // é¡¯ç¤ºçµæŸç•«é¢
            this.ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); // åŠé€æ˜èƒŒæ™¯

            this.ctx.fillStyle = "#ffffff";
            this.ctx.font = "36px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(message, this.canvas.width / 2, this.canvas.height / 2 - 20);
            this.ctx.font = "24px Arial";
            this.ctx.fillText("åˆ†æ•¸ï¼š" + this.score, this.canvas.width / 2, this.canvas.height / 2 + 20);
            this.ctx.fillText("é»æ“Šé‡æ–°é–‹å§‹", this.canvas.width / 2, this.canvas.height / 2 + 60);
        },

        /**
         * @brief: ç§»å‹•è›‡çš„å‡½æ•¸
         * @param {string} direction - ç§»å‹•æ–¹å‘ï¼Œå¯ä»¥æ˜¯ "up", "down", "left", "right"
         * @return: ç„¡
         */
        moveSnake(direction)
        {
            // å–å¾—è›‡é ­ä½ç½®
            let head = this.snake[0];
            
            // æ ¹æ“šæ–¹å‘ç§»å‹•è›‡é ­
            let newHead = { x: head.x, y: head.y };
            
            switch (direction)
            {
                case "up":
                    newHead.y -= SNAKE_SIZE;
                    break;
                case "down":
                    newHead.y += SNAKE_SIZE;
                    break;
                case "left":
                    newHead.x -= SNAKE_SIZE;
                    break;
                case "right":
                    newHead.x += SNAKE_SIZE;
                    break;
            }

            // æª¢æŸ¥æ˜¯å¦æ­»äº¡
            if (this.CheckGameOver())
            {
                this.EndGame(); // å¦‚æœæ­»äº¡ï¼Œå‰‡çµæŸéŠæˆ²
                return; // çµæŸå‡½æ•¸åŸ·è¡Œ
            }

            // æª¢æŸ¥è›‡æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (this.CheckFoodCollision(newHead))
            {
                // å¦‚æœåƒåˆ°é£Ÿç‰©ï¼Œå‰‡ä¸ç§»é™¤å°¾éƒ¨ç¯€é»
                // ä½†éœ€è¦åœ¨é ­éƒ¨æ·»åŠ æ–°çš„ç¯€é»
                this.snake.unshift(newHead); // åœ¨é ­éƒ¨æ·»åŠ æ–°çš„ç¯€é»
            }
            else
            {
                // å¦‚æœæ²’æœ‰åƒåˆ°é£Ÿç‰©ï¼Œå‰‡ç§»é™¤å°¾éƒ¨ç¯€é»
                this.snake.pop(); // ç§»é™¤å°¾éƒ¨ç¯€é»
                this.snake.unshift(newHead); // åœ¨é ­éƒ¨æ·»åŠ æ–°çš„ç¯€é»
            }
        },

        /**
         * @brief: ç”Ÿæˆé£Ÿç‰©ä½ç½®
         * @details: éš¨æ©Ÿç”¢ç”Ÿä¸€å€‹åˆæ³•ä½ç½®ï¼Œä¸¦ç¢ºä¿ä¸èˆ‡è›‡
         <è¨»> å¯å„ªåŒ–æ”¹Gridç³»çµ±ï¼Œä½¿ç”¨æ ¼å­å°é½Š
        */
        GenerateFood()
        {
            let valid = false; // æ˜¯å¦ç‚ºåˆæ³•ä½ç½®ï¼ˆæ²’æœ‰é‡ç–Šï¼‰

            while (!valid)
            {
                // éš¨æ©Ÿç”¢ç”Ÿä¸€å€‹é£Ÿç‰©åº§æ¨™ï¼Œå¿…é ˆå°é½Šæ ¼å­
                let x = Math.floor(Math.random() * (this.canvas.width / SNAKE_SIZE)) * SNAKE_SIZE;
                let y = Math.floor(Math.random() * (this.canvas.height / SNAKE_SIZE)) * SNAKE_SIZE;

                // é è¨­ç‚ºåˆæ³•ä½ç½®
                valid = true;

                // æª¢æŸ¥æ˜¯å¦èˆ‡è›‡çš„ä»»ä¸€ç¯€é»é‡ç–Š
                for (let i = 0; i < this.snake.length; i++) {
                    if (this.snake[i].x === x && this.snake[i].y === y) {
                        valid = false; // å¦‚æœæœ‰é‡ç–Šï¼Œå°±è¨­ç‚ºéæ³•ï¼Œé‡æ–°äº‚æ•¸
                        break;
                    }
                }

                // å¦‚æœæ²’æœ‰é‡ç–Šï¼Œå°±è¨­ç½®é€™å€‹ä½ç½®ç‚ºæ–°çš„é£Ÿç‰©ä½ç½®
                if (valid) {
                    this.food.x = x;
                    this.food.y = y;
                }
            }
        },

        /**
         * @brief: æª¢æŸ¥è›‡æ˜¯å¦åƒåˆ°é£Ÿç‰©
         * @details: å¦‚æœè›‡é ­ä½ç½®èˆ‡é£Ÿç‰©ä½ç½®ç›¸åŒï¼Œå‰‡å¢åŠ è›‡çš„é•·åº¦ä¸¦ç”Ÿæˆæ–°çš„é£Ÿç‰©
         * @param {Object} newHead - æ–°çš„è›‡é ­ä½ç½®ï¼ŒåŒ…å« x å’Œ y å±¬æ€§
         * @return: boolean - å¦‚æœåƒåˆ°é£Ÿç‰©è¿”å› trueï¼Œå¦å‰‡è¿”å› false
         */
        CheckFoodCollision(newHead)
        {
            if (newHead.x === this.food.x && newHead.y === this.food.y)
            {
                this.score += this.level; // å¢åŠ åˆ†æ•¸
                this.GenerateFood(); // ç”Ÿæˆæ–°çš„é£Ÿç‰©

                // æ›´æ–°åˆ†æ•¸ UI
                this.UpdateScoreUI();

                // æ’­æ”¾åƒåˆ°é£Ÿç‰©éŸ³æ•ˆ
                SOUND.eat.currentTime = 0; // é‡ç½®éŸ³æ•ˆæ’­æ”¾æ™‚é–“
                SOUND.eat.play(); // æ’­æ”¾éŸ³æ•ˆ

                return true; // è¿”å› true è¡¨ç¤ºåƒåˆ°é£Ÿç‰©
            }

            return false; // è¿”å› false è¡¨ç¤ºæ²’æœ‰åƒåˆ°é£Ÿç‰©
        },

        /**
         * @brief: æª¢æŸ¥æ˜¯å¦æ­»äº¡
         * @details: æª¢æŸ¥è›‡é ­æ˜¯å¦ç¢°åˆ°ç‰†å£æˆ–è‡ªèº«
         * @return: boolean - å¦‚æœæ­»äº¡è¿”å› trueï¼Œå¦å‰‡è¿”å› false
         */
        CheckGameOver()
        {
            // æª¢æŸ¥è›‡é ­æ˜¯å¦ç¢°åˆ°ç‰†å£
            const head = this.snake[0];
            if (head.x < 0 || head.x >= this.canvas.width || head.y < 0 || head.y >= this.canvas.height)
            {
                return true; // ç¢°åˆ°ç‰†å£ï¼ŒéŠæˆ²çµæŸ
            }

            // æª¢æŸ¥è›‡é ­æ˜¯å¦ç¢°åˆ°è‡ªèº«
            for (let i = 1; i < this.snake.length; i++)
            {
                if (head.x === this.snake[i].x && head.y === this.snake[i].y)
                {
                    return true; // ç¢°åˆ°è‡ªèº«ï¼ŒéŠæˆ²çµæŸ
                }
            }

            // æ²’æœ‰æ­»äº¡
            return false;
        },

        // #region UI

        /**
         * @brief: æ›´æ–°åˆ†æ•¸ UI é¡¯ç¤º
         */
        UpdateScoreUI()
        {
            const scoreBoard = document.getElementById("scoreBoard");
            if (scoreBoard) {
                scoreBoard.innerText = "åˆ†æ•¸ï¼š" + this.score;
            }
        },

        // #endregion UI        

      },
      mounted() {
          // å–å¾— canvas èˆ‡ç•«å¸ƒå…§å®¹
          const canvas = document.getElementById("gameCanvas");
          this.canvas = canvas;
          this.ctx = canvas.getContext("2d");

          // åˆå§‹åŒ–ç•«å¸ƒå¤§å°
          this.resizeCanvasIfMobile();

          // è¢å¹•å°ºå¯¸è®ŠåŒ–æ™‚ä¹Ÿè¦èª¿æ•´
          window.addEventListener("resize", this.resizeCanvasIfMobile);

          // ç›£è½éµç›¤äº‹ä»¶
          document.addEventListener("keydown", (e) =>
          {
              if (!this.isInitialized || this.gameStatus !== 1) {
                  return; // å¦‚æœéŠæˆ²æœªåˆå§‹åŒ–æˆ–æœªé–‹å§‹ï¼Œå‰‡ä¸è™•ç†éµç›¤
              }

              switch (e.key)
              {
                  case "ArrowUp":                
                      if(this.currentDirection !== "down")                    
                          this.currentDirection = "up";
                          console.log("å‘ä¸Š");
                  break;
                  case "ArrowDown":
                      if(this.currentDirection !== "up")
                          this.currentDirection = "down";
                          console.log("å‘ä¸‹");
                  break;
                  case "ArrowLeft":
                      if(this.currentDirection !== "right")
                          this.currentDirection = "left";
                          console.log("å‘å·¦");
                      break;
                  case "ArrowRight":
                      if(this.currentDirection !== "left")
                          this.currentDirection = "right";
                          console.log("å‘å³");
                  break;
              }
          });

          // ç›£è½è§¸æ§äº‹ä»¶
          this.canvas.addEventListener("touchstart", (e) => {
              const touch = e.touches[0];
              this.touchStartX = touch.clientX;
              this.touchStartY = touch.clientY;
          }, false);

          // ç›£è½è§¸æ§çµæŸäº‹ä»¶
          this.canvas.addEventListener("touchend", (e) => {
              const touch = e.changedTouches[0];
              const dx = touch.clientX - this.touchStartX;
              const dy = touch.clientY - this.touchStartY;

              // åˆ¤æ–·æ»‘å‹•æ–¹å‘ï¼ˆé¿å…èª¤è§¸å°æ»‘å‹•ï¼‰
              if (Math.abs(dx) > Math.abs(dy)) {
                  // å·¦å³æ»‘å‹•
                  if (dx > 30 && this.currentDirection !== "left") {
                      this.currentDirection = "right";
                  } else if (dx < -30 && this.currentDirection !== "right") {
                      this.currentDirection = "left";
                  }
              } else {
                  // ä¸Šä¸‹æ»‘å‹•
                  if (dy > 30 && this.currentDirection !== "up") {
                      this.currentDirection = "down";
                  } else if (dy < -30 && this.currentDirection !== "down") {
                      this.currentDirection = "up";
                  }
              }
          }, false);          
      }
    }).mount('#app');
  </script>

  <!-- âœ… åŸæœ¬ JS æš«æ™‚ä¿ç•™ -->
  <!--<script src="script.js"></script>-->
  
</body>
</html>
